#!/bin/bash

# Script para diagnosticar configuraciÃ³n de Meta para Instagram Messaging

echo "ğŸ” DIAGNÃ“STICO DE CONFIGURACIÃ“N META - INSTAGRAM MESSAGING"
echo "=========================================================="
echo ""

# Colores
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ“‹ CHECKLIST DE CONFIGURACIÃ“N EN META DEVELOPERS${NC}"
echo "   https://developers.facebook.com/apps"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1ï¸âƒ£  TIPO DE CUENTA DE INSTAGRAM"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo -e "${YELLOW}âš ï¸  REQUISITO CRÃTICO:${NC}"
echo "   La cuenta de Instagram que recibe mensajes DEBE ser:"
echo "   âœ… Cuenta PROFESIONAL (no Personal)"
echo "   âœ… Tipo: EMPRESA (Business) o CREADOR (Creator)"
echo "   âœ… Conectada a una PÃGINA DE FACEBOOK"
echo ""
echo "   âŒ NO funciona con cuentas Personales"
echo ""
echo "   CÃ³mo verificar:"
echo "   1. Abre Instagram â†’ Perfil â†’ MenÃº (â˜°)"
echo "   2. ConfiguraciÃ³n y Privacidad â†’ Tipo de cuenta y herramientas"
echo "   3. Debe decir 'Cuenta Profesional' o 'Cuenta de Empresa'"
echo ""
echo "   CÃ³mo cambiar a Profesional:"
echo "   1. Instagram â†’ Perfil â†’ MenÃº"
echo "   2. ConfiguraciÃ³n â†’ Cuenta"
echo "   3. Cambiar a cuenta profesional"
echo "   4. Seleccionar categorÃ­a â†’ Empresa"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "2ï¸âƒ£  PÃGINA DE FACEBOOK CONECTADA"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo -e "${YELLOW}âš ï¸  REQUISITO CRÃTICO:${NC}"
echo "   Instagram Business requiere una PÃ¡gina de Facebook"
echo ""
echo "   CÃ³mo conectar:"
echo "   1. Instagram â†’ Perfil â†’ Editar Perfil"
echo "   2. PÃ¡gina â†’ Crear una nueva pÃ¡gina de Facebook"
echo "   3. O conectar a pÃ¡gina existente"
echo ""
echo "   Verificar conexiÃ³n:"
echo "   1. Instagram â†’ ConfiguraciÃ³n â†’ Cuenta"
echo "   2. Debe aparecer 'PÃ¡gina de Facebook' conectada"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "3ï¸âƒ£  CONFIGURACIÃ“N DE WEBHOOKS EN META"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   Ir a: https://developers.facebook.com/apps"
echo "   â†’ Tu App â†’ Webhooks"
echo ""
echo -e "${GREEN}ConfiguraciÃ³n requerida:${NC}"
echo ""
echo "   Callback URL:"
echo "   https://afqbakvvfpebnxzjewsk.supabase.co/functions/v1/instagram-webhook"
echo ""
echo "   Verify Token:"
echo "   d368c7bd78882ba8aae97e480701363127efee4d7f2a2ed79c124fb123d088ec"
echo ""
echo -e "${GREEN}Suscripciones necesarias (checkbox activos):${NC}"
echo "   âœ… messages"
echo "   âœ… messaging_postbacks (opcional)"
echo "   âœ… messaging_optins (opcional)"
echo ""
echo -e "${YELLOW}IMPORTANTE:${NC}"
echo "   DespuÃ©s de configurar, debes SUSCRIBIR la PÃGINA:"
echo "   1. En Webhooks, busca tu PÃ¡gina de Facebook"
echo "   2. Haz clic en 'Subscribe' junto a la pÃ¡gina"
echo "   3. Selecciona los campos: messages"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "4ï¸âƒ£  PERMISOS DE LA APP"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   Ir a: https://developers.facebook.com/apps"
echo "   â†’ Tu App â†’ App Review â†’ Permissions and Features"
echo ""
echo -e "${GREEN}Permisos necesarios:${NC}"
echo "   âœ… instagram_business_basic (Standard Access)"
echo "   âœ… instagram_business_manage_messages (Standard Access)"
echo "   âœ… pages_manage_metadata (Standard Access)"
echo ""
echo -e "${YELLOW}Nota:${NC} En modo desarrollo, algunos permisos funcionan sin App Review"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "5ï¸âƒ£  INSTAGRAM TESTERS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   Ir a: https://developers.facebook.com/apps"
echo "   â†’ Tu App â†’ Roles â†’ Instagram Testers"
echo ""
echo -e "${GREEN}Pasos:${NC}"
echo "   1. Agregar ambas cuentas como Instagram Testers:"
echo "      - Cuenta que RECIBE mensajes (Business)"
echo "      - Cuenta que ENVÃA mensajes (tester)"
echo ""
echo "   2. Cada cuenta debe ACEPTAR la invitaciÃ³n:"
echo "      Instagram â†’ ConfiguraciÃ³n â†’ Apps y sitios web"
echo "      â†’ Invitaciones de probador â†’ Aceptar"
echo ""
echo -e "${YELLOW}IMPORTANTE:${NC} Sin aceptar la invitaciÃ³n, NO funcionarÃ¡"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "6ï¸âƒ£  VERIFICAR QUE LA PÃGINA ESTÃ‰ VINCULADA A LA APP"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   Ir a: https://developers.facebook.com/apps"
echo "   â†’ Tu App â†’ ConfiguraciÃ³n â†’ BÃ¡sico"
echo "   â†’ Scroll hasta 'PÃ¡ginas de Facebook'"
echo ""
echo "   La pÃ¡gina de Facebook conectada a tu Instagram debe aparecer aquÃ­"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "7ï¸âƒ£  PROBAR EL WEBHOOK"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   Desde la cuenta TESTER, envÃ­a un DM a la cuenta BUSINESS:"
echo ""
echo "   ğŸ“± Instagram â†’ Buscar la cuenta business"
echo "      â†’ Enviar mensaje: 'Hola, esto es una prueba'"
echo ""
echo -e "${GREEN}Verificar en logs:${NC}"
echo "   Ejecuta en otra terminal:"
echo "   tail -f /var/log/supabase-webhook.log"
echo ""
echo "   O usa la herramienta de Meta:"
echo "   Meta Developers â†’ Tu App â†’ Webhooks â†’ Test"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“š RECURSOS ÃšTILES"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   ğŸ“– Instagram Messaging API:"
echo "      https://developers.facebook.com/docs/messenger-platform/instagram"
echo ""
echo "   ğŸ“– Webhooks Setup:"
echo "      https://developers.facebook.com/docs/graph-api/webhooks/getting-started"
echo ""
echo "   ğŸ“– Instagram Graph API:"
echo "      https://developers.facebook.com/docs/instagram-api"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${GREEN}âœ… PRÃ“XIMOS PASOS${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   1. Verifica que tu cuenta de Instagram sea PROFESIONAL/EMPRESA"
echo "   2. Conecta una PÃ¡gina de Facebook"
echo "   3. Configura el webhook en Meta Developers"
echo "   4. Suscribe la pÃ¡gina al webhook"
echo "   5. Agrega testers y acepta invitaciones"
echo "   6. EnvÃ­a un mensaje de prueba"
echo "   7. Verifica los logs del webhook"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
