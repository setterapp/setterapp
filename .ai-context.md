# AppSetter (setterapp.ai) - AI Context

## Project Overview
Multi-channel CRM and messaging platform with AI-powered lead classification and automated responses. Users can manage conversations from Instagram, Messenger, and WhatsApp in one place.

## Tech Stack
- **Frontend**: React + TypeScript + Vite
- **Backend**: Supabase (PostgreSQL + Edge Functions + Realtime)
- **AI**: OpenAI GPT-3.5-turbo (lead classification) + GPT-4o-mini (auto-replies)
- **Platforms**: Instagram, Facebook Messenger, WhatsApp Business

## Key Architecture

### Database (Supabase)
- `users` - User accounts
- `conversations` - Chat conversations with `lead_status` (cold/warm/hot/closed/not_closed)
- `messages` - Individual messages with direction (inbound/outbound)
- `contacts` - Contact profiles with CRM data
- `integrations` - Platform connections (Instagram/Messenger/WhatsApp)
- `agents` - AI agent configurations per platform

### Edge Functions (Deno)
- `instagram-webhook` - Receives Instagram messages, saves to DB, triggers AI responses + lead classification
- `messenger-webhook` - Same for Facebook Messenger
- `whatsapp-webhook` - Same for WhatsApp
- `detect-lead-status` - Classifies conversation lead status using GPT-3.5-turbo
- `facebook-exchange-token`, `instagram-exchange-token` - OAuth token management

### Frontend Structure
- `src/pages/Conversations.tsx` - Main conversation view with split panel
- `src/hooks/useConversations.ts` - Fetches conversations with Realtime updates
- `src/hooks/useMessages.ts` - Fetches messages + calls auto-classification on new inbound messages
- `src/services/ai/leadStatusDetection.ts` - Lead classification logic (frontend + shared types)

## Lead Classification System

### How It Works
1. **Webhook receives message** â†’ Saves to `messages` table
2. **Webhook calls** `detect-lead-status` Edge Function asynchronously
3. **Edge Function**:
   - Fetches last 12 messages from conversation
   - Sends to GPT-3.5-turbo with classification prompt
   - Updates `conversations.lead_status` and `contacts.lead_status`
4. **Frontend (if user has conversation open)**:
   - `useMessages` detects new inbound message via Realtime
   - Also calls `autoClassifyLeadStatus` (fallback/redundancy)

### Lead Statuses
- **cold** - Not interested, negative
- **warm** - Moderate interest, basic questions
- **hot** - Very interested, asks prices/dates
- **closed** - Purchase completed successfully
- **not_closed** - Closed without conversion

## Important Notes
- All webhooks run async classification to avoid blocking webhook responses
- Frontend shows lead status badges in conversation list
- Manual classification banner was removed (now fully automatic)
- Instagram webhook has duplicate message detection (Meta can send same message multiple times)
- All webhooks support debug mode via `config.debug_webhooks` flag in integrations table

## Common Tasks
- **Add new platform**: Create webhook Edge Function + integration type in DB
- **Modify lead classification**: Edit `detect-lead-status` Edge Function
- **Change AI prompts**: Check both Edge Function and `leadStatusDetection.ts`
